<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/client/layout}"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<th:block layout:fragment="content">
    <script th:src="@{/client/js/regist.js}"></script>
    <link rel="stylesheet" th:href="@{/client/css/regist.css}">

    <section>
        <!-- 여기에 작성 -->
        <div id="main_category_route">
            <ul class="route_list">
                <li onclick="location.href='/'"><img src="/client/images/icon/home.png" alt="홈으로가기"></li>
                <li>&gt;</li>
                <li>회원가입</li>
            </ul>
            <div id="contents">
                <form th:action="@{/auth/regist}" id="regist" method="post">
                    <h1 id="regist_header">회원가입</h1>
                    <div id="agree_list">
                        <div id="termsAndConditionContainer">
                            <p>쇼핑몰 이용약관 동의</p>
                            <div th:utext="${termsAndConditions}">
                                <p>Default Content</p>
                            </div>
                            <div>
                                <label for="agree1">동의하기</label>
                                <img th:src="@{/client/images/icon/check_false.png}" alt="체크표시(false)" id="check_agree1"
                                     onclick="agreeCheckImg(this)">
                                <input type="checkbox" id="agree1" name="agree1" onchange="agreeCheckbox(this)">
                            </div>
                        </div>
                        <div id="privacyPolicyContainer">
                            <p>개인정보 수집/이용에 관한 사항</p>
                            <div th:utext="${privacyPolicy}">
                                <p>Default Content</p>
                            </div>
                            <div>
                                <label for="agree2">동의하기</label>
                                <img th:src="@{/client/images/icon/check_false.png}" alt="체크표시(false)" id="check_agree2"
                                     onclick="agreeCheckImg(this)">
                                <input type="checkbox" id="agree2" name="agree2" onchange="agreeCheckbox(this)">
                            </div>
                        </div>
                    </div>

                    <table id="contents_table">
                        <tr>
                            <th>이름</th>
                            <td colspan="2"><input type="text" name="name" id="name"></td>
                        </tr>
                        <tr>
                            <th>생년월일</th>
                            <td colspan="2"><input type="date" name="birthday" id="birthday"></td>
                        </tr>
                        <tr>
                            <th>성별</th>
                            <td colspan="2">
                                <label for="male">남</label>
                                <input type="radio" name="gender" id="male" value="male">
                                <label for="female">여</label>
                                <input type="radio" name="gender" id="female" value="female">
                            </td>
                        </tr>
                        <tr>
                            <th>아이디</th>
                            <td>
                                <input type="text" name="userId" id="userId">
                                <input type="button" value="중복체크" id="id_check_button">
                                <div id="check_text"></div>
                            </td>
                            <td>공백없는 8~20자리의 영문/숫자<br>(적어도 하나의 숫자와 영문자)</td>
                            <script>
                                let regexId = /^(?=.*[a-zA-Z])(?=.*\d)[a-zA-Z\d]{8,20}$/;
                                $('#id_check_button').click(function () {
                                    $('#id_check_button').css('display', 'none');
                                    $('#check_text').css('display', 'none');
                                    const userId = $('#userId').val();
                                    const isValid = regexId.test(userId);
                                    if (isValid) {
                                        $.ajax({
                                            url: "/auth/checkId",
                                            method: "POST",
                                            data: {userId: userId},
                                            success: function (result) {
                                                if (result.result === "success") { // 아이디가 없으면
                                                    $('#check_text').css('display', 'block');
                                                    $('#check_text').text('중복체크 완료')
                                                } else { // 아이디가 있으면
                                                    $('#id_check_button').css('display', 'inline');
                                                    $('#check_text').css('display', 'block');
                                                    $('#check_text').text('아이디가 있습니다.')
                                                }
                                            },
                                            error: function (error) {
                                                console.log(error);
                                                alert('예상치 못한 오류가 발생했습니다.\n메인화면으로 돌아갑니다.');
                                                location.href = '/';
                                            }
                                        })
                                    } else {
                                        $('#id_check_button').css('display', 'inline');
                                        $('#check_text').css('display', 'block');
                                        $('#check_text').html('규칙에 맞지 않습니다<br>다시입력해주세요.');
                                    }
                                });
                            </script>
                        </tr>
                        <tr>
                            <th>비밀번호</th>
                            <td><input type="password" id="userPwd" name="userPwd"></td>
                            <td>공백없는 8~20자리의 영문/숫자/특수문자<br>
                                <span id="warning">특수문자는 !@#$%^&* 사용가능</span>
                            </td>
                        </tr>
                        <tr>
                            <th>비밀번호확인</th>
                            <td colspan="2"><input type="password" input="password2" id="password2"></td>
                        </tr>
                        <tr id="email_row">
                            <th>이메일</th>
                            <td colspan="2">
                                <div id="email_input_wrap">
                                    <input type="text" name="email" id="email">
                                    <input id="email_button" value="이메일인증" type="button">
                                </div>
                                <div id="email_authentication">
                                    <div>인증번호</div>
                                    <input type="text" id="email_authentication_number"
                                           name="email_authentication_number">
                                    <input id="hidden_certified_key" name="hidden_certified_key" hidden>
                                    &nbsp;
                                    <input type="button" id="email_authentication_button" value="인증하기">
                                    &nbsp;
                                    <span id="reload_timer">05:00</span>
                                    &nbsp;
                                    <img src="/client/images/icon/reload.png" alt="시간연장" id="reload">
                                </div>
                                <div id="email_message"></div>
                                <script>
                                    let countdownTimer = null;

                                    function startCountdown() {
                                        let timeRemaining = 299;
                                        countdownTimer = setInterval(() => {
                                            const minutes = Math.floor(timeRemaining / 60);
                                            const seconds = timeRemaining % 60;
                                            const formattedTime = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
                                            document.querySelector("#reload_timer").textContent = formattedTime;
                                            if (timeRemaining <= -1) {
                                                alert("시간초과로 새로고침됩니다.");
                                                clearInterval(countdownTimer);
                                                location.href = '/auth/regist';
                                            }
                                            timeRemaining--;
                                        }, 1000);
                                    }

                                    let regexEmail = /^[a-zA-Z0-9._$+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                                    $('#email_button').click(function () {
                                        $('#email_button').css('display', 'none');
                                        const email = $('#email').val(); // 입력한 email 값
                                        const isValid = regexEmail.test(email); // email이 정규식에 맞는가.
                                        if (isValid) {
                                            $.ajax({
                                                url: "/auth/checkEmail",
                                                method: "POST",
                                                data: {email: email},
                                                success: function (result) {
                                                    if (result.result === "success") {
                                                        $('#email_message').html('');
                                                        $('#email_button').css('display', '');
                                                        $('#email_button').val('인증완료');
                                                        $(document).ready(() => $('#email_button').off("click"));
                                                        $('#email_authentication').css('display', '');
                                                        $('#hidden_certified_key').val(result.certifiedCode);
                                                        startCountdown();
                                                        $('#reload').click(() => {
                                                            clearInterval(countdownTimer);
                                                            $('#reload_timer').text("05:00");
                                                            startCountdown();
                                                        });
                                                    } else {
                                                        $('#email_button').css('display', '');
                                                        $('#email_message').html('이미 있는 이메일입니다.<br>다시 입력해주세요.');
                                                    }
                                                },
                                                error: function (error) {
                                                    console.log(error);
                                                    alert('예상치 못한 오류가 발생했습니다.\n메인화면으로 돌아갑니다.');
                                                    location.href = '/';
                                                }
                                            })
                                        } else {
                                            $('#email_button').css('display', '');
                                            $('#email_message').html('이메일 규칙에 맞지 않습니다.<br>다시시도해주세요.');
                                        }
                                    })
                                </script>
                                <script>
                                    $('#email_authentication_button').click(function () {
                                        clearInterval(countdownTimer); // 일단 타이머 중지.
                                        $(document).ready(() => $('#reload').off("click")); // reload 버튼도 중지
                                        const inputCertifiedCode = $("#email_authentication_number").val();
                                        const certifiedKey = $('#hidden_certified_key').val();
                                        $.ajax({
                                            url: "/auth/emailCertify",
                                            method: "POST",
                                            data: {inputCertifiedCode: inputCertifiedCode, certifiedKey: certifiedKey},
                                            success: function (result) {
                                                if (result.result === "success") {
                                                    $("#email_input_wrap").css('display', 'none');
                                                    $("#email_authentication").css('display', 'none');
                                                    $("#email_message").css('font-size', '1.25em');
                                                    $("#email_message").css('color', 'black');
                                                    $("#email_message").html('인증이 완료되었습니다.');
                                                } else {
                                                    /*실패하면 타이머 다시 작동하기.*/
                                                    $("#email_message").html('다시 입력해주세요.');
                                                    startCountdown();
                                                    $('#reload').click(() => {
                                                        clearInterval(countdownTimer);
                                                        $('#reload_timer').text("05:00");
                                                        startCountdown();
                                                    });
                                                }
                                            },
                                            error: function (error) {
                                                console.log(error);
                                                alert('예상치 못한 오류가 발생했습니다.\n메인화면으로 돌아갑니다.');
                                                location.href = '/';
                                            }
                                        });


                                    });
                                </script>
                                <div>
                                    email 서비스를 받으시겠습니까?&nbsp;
                                    <input type="radio" name="email_service" id="email_yes"><label for="email_yes">&nbsp;예</label>
                                    <input type="radio" name="email_service" id="email_no"><label for="email_yes">&nbsp아니오</label>
                                </div>
                                <div>
                                    주문 및 배송 관련 정보는 수신 동의와 상관없이 자동 발송됩니다.
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>휴대전화</th>
                            <td colspan="2"><input type="text" id="phone" name="phone" placeholder="01011112222(- 생략)">
                            </td>
                        </tr>
                    </table>
                    <div id="bottom_buttons">
                        <input type="submit" name="regist_button" id="regist_button" value="회원가입">
                    </div>
                    <script th:inline="javascript">
                        <![CDATA[
                        var message = [[${message}]];
                        if (message) {
                            alert(message);
                        }
                        ]]>
                    </script>
                </form>
            </div>
        </div>

    </section>

</th:block>
</html>